package app.mp3Editor;
/*
 * Created by Mars Tan on 12/1/2016.
 * Copyright ISOTOPE Studio
 */

import com.mpatric.mp3agic.*;
import io.fileOperation.Write;

import java.io.File;
import java.io.IOException;
import java.io.PrintWriter;
import java.io.StringWriter;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.Scanner;

public class EditorMain {

    private static List<File> fileList = new ArrayList<>();

    private static List<String> log = new ArrayList<>();

    private static final SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd_HH_mm_ss");
    private static final SimpleDateFormat sdf2 = new SimpleDateFormat("[yyyy-MM-dd HH:mm:ss] ");

    private static final String path = "C:\\Users\\Mars Tan\\Desktop\\mp3 - Copy\\Season 2\\1\\";

    public static void main(String args[]) {
        File root = new File(path);

        try {
            addAllmp3Files(root);

            Scanner sc = new Scanner(System.in);
            System.out.println("Continue?");
            sc.next();

            for (File mp3 : fileList) {
                log("Now Processing " + mp3.getName());
                processFile(mp3);
                log("");
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < log.size(); i++) {
            sb.append(log.get(i) + "\n");
        }
        Date date = new Date();
        String dateString = sdf.format(date);
        Write.write(new File(path + dateString + ".log"), sb.toString());
    }

    private static void addAllmp3Files(File dir) throws Exception {
        File[] fs = dir.listFiles();
        for (File file : fs) {
            if (file.isDirectory()) {
                log("Folder: " + file.getAbsolutePath());
                try {
                    addAllmp3Files(file);
                } catch (Exception e) {
                    e.printStackTrace();
                }
            } else {
                if (file.getName().endsWith(".mp3")) {
                    fileList.add(file);
                    log("\tAdded file " + file.getName());
                }
            }
        }
    }

    private static void processFile(File mp3) {
        Mp3File mp3file;
        try {
            mp3file = new Mp3File(mp3);
            final Info info = getInfo(mp3.getName());
            ID3v1 tag = new ID3v1Tag();
//           ID3v1 tag = mp3file.getId3v1Tag();
            tag.setTrack(info.getEpisode() + "");
            tag.setArtist("The Big Bang Theory");
            tag.setTitle(info.getName());
            tag.setAlbum("The Big Bang Theory Season " + info.getSeason());
            tag.setComment("Generated by Mars");
            mp3file.setId3v1Tag(tag);
            mp3file.save(mp3.getParent() + "\\" + info.getFullName() + "mp3");
            tag = new Mp3File(mp3.getParent() + "\\" + info.getFullName() + "mp3").getId3v1Tag();
            log("Track: " + tag.getTrack());
            log("Artist: " + tag.getArtist());
            log("Title: " + tag.getTitle());
            log("Album: " + tag.getAlbum());
            log("Comment: " + tag.getComment());
        } catch (IOException | UnsupportedTagException | InvalidDataException | NotSupportedException e) {
            log(getStackTrace(e));
        }
    }

    private static Info getInfo(String s) {
        int sub = s.indexOf("Theory");
        if (sub == -1)
            sub = s.indexOf("theory");
        String info[] = s.substring(sub + 7, sub + 13).split("(E|S|e|s)");
        int season = Integer.parseInt(info[1]);
        int episode = Integer.parseInt(info[2]);
        return new Info(season, episode);
    }

    private static class Info {
        private int season;
        private int episode;

        Info(int season, int episode) {
            this.season = season;
            this.episode = episode;
        }

        int getSeason() {
            return season;
        }

        int getEpisode() {
            return episode;
        }

        String getFullName() {
            return "The Big Bang Theory. Season " + season + " Episode " + episode + ".";
        }

        String getName() {
            return "The Big Bang Theory. S" + (season < 10 ? "0" : "") + season + "E" + (episode < 10 ? "0" : "") + episode + "";
        }
    }

    private static void log(String info) {
        log.add(sdf2.format(new Date()) + info);
        System.out.println(info);
    }

    private static String getStackTrace(Throwable t) {
        StringWriter sw = new StringWriter();
        try (PrintWriter pw = new PrintWriter(sw)) {
            t.printStackTrace(pw);
            return sw.toString();
        }
    }

}
